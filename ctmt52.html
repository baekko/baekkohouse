<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>음식 순서 맞추기</title>
<style>
  body{
    background-image:url("ctm52.jpg");
    background-size:cover;background-position:center;
    display:flex;justify-content:center;align-items:center;
    height:100vh;flex-direction:column;font-family:Arial,sans-serif;margin:0;
  }
  .image-overlay{
    position:absolute;top:70%;left:50%;transform:translate(-50%,-50%);
    width:300px;height:450px;z-index:-500;user-select:none;pointer-events:none;
  }

  /* 하단 색/컨트롤 버튼 줄 */
  .color-container{
    display:flex;justify-content:center;gap:10px;position:fixed;bottom:70px;
    left:50%;transform:translateX(-50%);flex-wrap:nowrap;
  }
  .color-button,.confirm-button,.action-button{
    width:35px;height:35px;background-size:cover;background-position:center;
    border:none;border-radius:10px;cursor:pointer;transition:transform .2s ease-in-out;
    box-shadow:0 4px 6px rgba(0,0,0,.2);
  }
  .color-button:hover{ transform:scale(1.1); }
  .confirm-button,.action-button{
    padding:6px 4px;font-size:12px;font-weight:bold;color:#fff;background:orange;border-radius:5px;
  }

  /* 힌트/합계 버튼 줄 */
  .button-container{
    position:fixed;bottom:15px;left:50%;transform:translateX(-50%);
    display:flex;gap:10px;
  }
  .hint-button{
    padding:4px 6px;width:65px;font-size:12px;font-weight:bold;cursor:pointer;
    color:#fff;background:orange;border:none;border-radius:5px;
    box-shadow:0 4px 6px rgba(0,0,0,.466);
  }
  .hint-button:disabled{
    background-color:rgb(109,93,93)!important;cursor:not-allowed;opacity:.8;
  }

  /* 모달 */
  .modal{
    display:none;position:fixed;z-index:1000;left:50%;top:50%;transform:translate(-50%,-50%);
    width:300px;padding:15px;background:#fff;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.2);
  }
  .modal-content{text-align:center;position:relative;}
  .close{
    position:absolute;top:50%;right:10px;transform:translateY(-50%);
    font-size:20px;font-weight:bold;cursor:pointer;
  }

  /* 정답 보상 영상 오버레이 */
  .video-overlay{
    display:none; /* 초기엔 반드시 none */
    position:fixed;inset:0;background:rgba(0,0,0,.6);
    z-index:2000;align-items:center;justify-content:center;
  }
  .video-box{
    width:min(70vw,420px);background:#000;border-radius:12px;overflow:hidden;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  video{width:100%;height:auto;display:block}
  /* === [추가] 미션 오버레이: 배경 투명, 초기 완전 숨김 === */
#missionOverlay{
  display:none;               /* 초기엔 완전 숨김 → 까만 박스 방지 */
  position:fixed;
  inset:0;
  z-index:1500;
  background:transparent;     /* 배경 어두워지지 않게 */
  align-items:center;
  justify-content:center;
}

/* 영상 컨테이너(선택): 영상만 살짝 강조하고 싶을 때 */
#missionOverlay .video-box{
  width:min(70vw,420px);
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 6px 16px rgba(0,0,0,.35);
}

/* === [중요 추가] video 초기 숨김 → 기본 검은 배경 노출 방지 === */
#missionVideo{
  display:none;               /* 1초 대기 중엔 비디오 자체를 숨김 */
}

  @media (max-width:768px){
    .color-button{width:35px;height:35px;}
    .confirm-button,.action-button{font-size:12px;padding:6px 4px;}
    .hint-button{font-size:12px;padding:4px 6px;}
  }
</style>
</head>
<body>
  <!-- 고양이 프레임 애니메이션 -->
  <img id="catImage" class="image-overlay" src="daniel1.png" alt="고양이 장난감">

  <!-- 색 선택 + 컨트롤 -->
  <div class="color-container">
    <button class="color-button" style="background-image:url('feather1.png');" onclick="recordSelection('노란색')"></button>
    <button class="color-button" style="background-image:url('feather2.png');" onclick="recordSelection('빨간색')"></button>
    <button class="color-button" style="background-image:url('feather3.png');" onclick="recordSelection('파란색')"></button>
    <button class="color-button" style="background-image:url('feather4.png');" onclick="recordSelection('검은색')"></button>
    <button class="color-button" style="background-image:url('feather5.png');" onclick="recordSelection('갈색')"></button>

    <button class="confirm-button" onclick="checkSequence()">입력</button>
    <button class="action-button" onclick="resetGame()">처음</button>
  </div>

  <!-- 힌트/합계 -->
  <div class="button-container">
    <button id="hint1" class="hint-button">힌트 1</button>
    <button id="hint2" class="hint-button" disabled>힌트 2</button>
    <button id="answerBtn" class="hint-button" disabled>정답 보기</button>
    <button id="totalBtn" class="hint-button">츄르 합계</button>
  </div>

  <!-- 안내 모달 -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <p id="modalText"></p>
    </div>
  </div>
  <!-- === [추가] 미션(인트로) 영상 오버레이 === -->
<div id="missionOverlay" aria-hidden="true">
  <div class="video-box">
    <video id="missionVideo" playsinline muted></video>
  </div>
</div>

  <!-- 보상 영상 -->
  <div id="videoOverlay" class="video-overlay" aria-hidden="true">
    <div class="video-box">
      <video id="rewardVideo" playsinline muted></video>
    </div>
  </div>

<script>
/* ===== 퍼즐 정답 시퀀스 & 페이지 설정 ===== */
const correctSequence = ['노란색','파란색','빨간색','갈색'];
const nextUrl = "https://baekko.github.io/baekkohouse/ctm53.html";

/* ===== 선택 기록 ===== */
let userInput = []; // 최대 4개

/* ===== 힌트 진행도 (0~3) ===== */
let hintLevel = 0;

/* ===== 합계/중복가산 키 ===== */
const CHURU_KEY = "churuTotal";
const PAGE_KEY  = "settled:" + location.pathname; // 이 페이지는 1회만 가산
if (localStorage.getItem(CHURU_KEY) === null) localStorage.setItem(CHURU_KEY,"0");

/* ===== 엘리먼트 ===== */
const $modal = document.getElementById('modal');
const $modalText = document.getElementById('modalText');
const $close = document.getElementById('closeModal');

const $hint1 = document.getElementById('hint1');
const $hint2 = document.getElementById('hint2');
const $ansBtn = document.getElementById('answerBtn');
const $totalBtn = document.getElementById('totalBtn');

const $overlay = document.getElementById('videoOverlay');
const $video = document.getElementById('rewardVideo');
const $cat = document.getElementById('catImage');

/* ===== 모달 공통 ===== */
function openModal(txt){ $modalText.innerText = txt; $modal.style.display = "block"; }
function closeModal(){ $modal.style.display = "none"; }
$close.onclick = closeModal;
window.addEventListener('click', e => { if (e.target === $modal) closeModal(); });

/* ===== 색 선택 ===== */
function recordSelection(color){
  if (userInput.length < correctSequence.length){
    userInput.push(color);
  }
}

/* ===== 정답 확인 ===== */
function checkSequence(){
  const ok = userInput.length === correctSequence.length &&
             userInput.every((v,i)=> v === correctSequence[i]);

  if (ok){
    closeModal();
    handleCorrectOnce();
  }else{
    openModal("순서가 틀린것 같아!");
    userInput = []; // 오답 시 초기화
  }
}

/* ===== 힌트/정답 보기 ===== */
$hint1.onclick = () => {
  openModal("흔들라니까!");
  if (hintLevel < 1) hintLevel = 1;
  $hint2.disabled = false;
};
$hint2.onclick = () => {
  openModal("깃발을 물기 전에 직전 준비자세가 있어!\n 가장 처음 무는 깃발은 노란색이야.");
  if (hintLevel < 2) hintLevel = 2;
  $ansBtn.disabled = false;
};
$ansBtn.onclick = () => {
  openModal("노란색-파란색-빨간색-갈색");
  if (hintLevel < 3) hintLevel = 3;
};
$totalBtn.onclick = () => {
  const t = Number(localStorage.getItem(CHURU_KEY)||"0");
  openModal(`현재까지 획득한 츄르: ${t}개`);
};

/* ===== 정답 처리: 한 번만 가산 → 보상영상 → 다음 페이지 ===== */
function handleCorrectOnce(){
  if (localStorage.getItem(PAGE_KEY) === "1"){
    // 이미 처리된 페이지면 가산 없이 영상만
    playRewardAndGo();
    return;
  }
  const addMap = [3,2,1,0]; // 힌트 사용량에 따른 획득량
  const add = addMap[hintLevel] ?? 0;
  const cur = Number(localStorage.getItem(CHURU_KEY)||"0");
  localStorage.setItem(CHURU_KEY, String(cur + add));
  localStorage.setItem(PAGE_KEY, "1"); // ✅ 중복가산 방지

  playRewardAndGo();
}

function playRewardAndGo(){
  const src = ["curu1.mp4","curu2.mp4","curu3.mp4","curu4.mp4"][hintLevel] || "curu4.mp4";
  $video.src = src;

  // 🔇 음소거 보장 & 모바일 자동재생 Friendly
  $video.muted = true; $video.defaultMuted = true; $video.volume = 0;

  $video.currentTime = 0;
  $overlay.style.display = "flex";
  $overlay.setAttribute("aria-hidden","false");

  // 버튼 잠금
  [$hint1,$hint2,$ansBtn,$totalBtn].forEach(b=>b.disabled = true);

  // 끝나면 다음 페이지
  $video.onended = () => { location.href = nextUrl; };

  const p = $video.play();
  if (p && typeof p.catch === "function"){
    p.catch(()=>{ $video.setAttribute('controls','controls'); });
  }
}

/* ===== 고양이 프레임 애니메이션(흔들기) ===== */
let images = [
  "daniel1.png","daniel2.png","daniel1.png","daniel3.png",
  "daniel1.png","daniel2.png","daniel1.png","daniel3.png",
  "daniel4.png","daniel5.png","daniel5.png",
  "daniel1.png","daniel2.png","daniel1.png","daniel3.png",
  "daniel1.png","daniel2.png","daniel1.png","daniel3.png",
  "daniel4.png","daniel6.png","daniel6.png",
  "daniel1.png","daniel2.png","daniel1.png","daniel3.png",
  "daniel1.png","daniel2.png","daniel1.png","daniel3.png",
  "daniel4.png","daniel7.png","daniel7.png",
  "daniel1.png","daniel2.png","daniel1.png","daniel3.png",
  "daniel1.png","daniel2.png","daniel1.png","daniel3.png",
  "daniel4.png","daniel8.png","daniel8.png"
];
let currentIndex = 0;
let shakeCount = 0;
let lastUpdate = Date.now();
const threshold = 40;       // 가속도 임계치
const requiredShakes = 5;   // 프레임 전환에 필요한 흔들림 횟수

function nextImage(){
  if (currentIndex < images.length - 1){
    currentIndex++;
    $cat.src = images[currentIndex];
  }
}
function resetGame(){
  $cat.src = "daniel1.png";
  currentIndex = 0;
  shakeCount = 0;
  userInput = [];
  openModal("초기화했어. 다시 시도해봐!");
}

/* devicemotion 리스너: 흔들면 프레임 전환 */
window.addEventListener("devicemotion", (event)=>{
  const a = event.acceleration || event.accelerationIncludingGravity || {x:0,y:0,z:0};
  const change = Math.abs(a.x||0) + Math.abs(a.y||0) + Math.abs(a.z||0);
  if (change > threshold && Date.now() - lastUpdate > 100){
    lastUpdate = Date.now();
    shakeCount++;
    if (shakeCount >= requiredShakes){
      shakeCount = 0;
      nextImage();
    }
  }
});
  /* === [추가] 페이지 로드 후 1초 뒤, 미션 영상 표시(배경 어둡지 않음) === */
/* 포인트: 1초가 지나기 전까지는 overlay도, video도 display:none → 까만 박스 없음 */
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const $missionOverlay = document.getElementById('missionOverlay');
    const $missionVideo   = document.getElementById('missionVideo');

    // 1초 후에야 src 지정 → video 기본 검정 화면 노출 차단
    $missionVideo.src = "mission.mp4";

    // 모바일 자동재생 대응
    $missionVideo.muted = true;
    $missionVideo.defaultMuted = true;
    $missionVideo.volume = 0;
    $missionVideo.currentTime = 0;

    // 이제 화면에 표시
    $missionOverlay.style.display = "flex";
    $missionVideo.style.display   = "block";

    // 종료 시 자동 숨김 + 언로드
    $missionVideo.onended = () => {
      $missionOverlay.style.display = "none";
      $missionVideo.style.display   = "none";
      $missionVideo.removeAttribute("src");
      $missionVideo.load();
    };

    // 자동재생 시도 (실패 시 controls 노출)
    const playPromise = $missionVideo.play();
    if (playPromise && typeof playPromise.catch === "function"){
      playPromise.catch(() => {
        $missionVideo.setAttribute("controls","controls");
      });
    }
  }, 1000); // 1초 대기
});

</script>
</body>
</html>


