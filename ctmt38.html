<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>관장님의 비밀업무</title>
<style>
  body{
    background-image:url("ctmt38.jpg"); /* ← 항상 기본 배경으로 시작 */
    background-size:cover;background-position:center;background-attachment:fixed;
    font-family:Arial,sans-serif;margin:0;
  }
  .grid-container{
    display:grid;grid-template-columns:repeat(7,1fr);gap:0;width:70vw;max-width:350px;
    transform:translateX(-6px);top:100px;margin-left:auto;margin-right:auto;
  }
  .image-box{
    width:100%;aspect-ratio:1/1;border:.2px solid rgb(192,191,191);background-size:cover;cursor:pointer;
  }
  .container{
    background:rgba(0,0,0,.4);padding:10px;border-radius:10px;text-align:center;
    position:fixed;bottom:50px;left:50%;transform:translateX(-50%);width:60%;max-width:375px;
    display:flex;flex-direction:column;align-items:center;
  }
  .button-container{
    position:fixed;bottom:15px;left:50%;transform:translateX(-50%);display:flex;gap:10px;
  }
  .input-container{display:flex;align-items:center;width:100%;justify-content:center;}
  input{
    padding:8px;font-size:14px;width:60%;border:none;border-radius:5px;margin-right:10px;caret-color:orange;
  }
  button{
    padding:4px 6px;width:65px;font-size:12px;font-weight:bold;cursor:pointer;color:#fff;
    background:orange;border:none;border-radius:5px;box-shadow:0 4px 6px rgba(0,0,0,.466);
  }
  button:disabled{background:rgb(109,93,93)!important;cursor:not-allowed;opacity:.8}
  .modal{
    display:none;position:fixed;z-index:1000;left:50%;top:50%;transform:translate(-50%,-50%);
    width:300px;padding:15px;background:#fff;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.2);
  }
  .modal-content{text-align:center;position:relative;}
  #modalTextBelow{text-align:center;display:block;margin-top:10px;}
  #correctModal img{display:block;margin:0 auto;}
  #correctModal{background:#fff}
  .close{
    position:absolute;top:50%;right:10px;transform:translateY(-50%);font-size:20px;font-weight:bold;cursor:pointer;
  }
  .modal img{max-width:100%;margin-top:10px;}
  .highlight-text{color:orange;font-weight:bold;}

  /* 미션 오버레이(배경 어둡게 X, 초기 숨김) */
  #missionOverlay{
    display:none; position:fixed; inset:0; z-index:1500; background:transparent;
    align-items:center; justify-content:center;
  }
  #missionOverlay .video-box{
    width:min(70vw,420px); border-radius:12px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,.35);
  }
  #missionVideo{ display:none; }

  @media (max-width:768px){
    .grid-container{margin-top:40px;}
    .container{width:80%;padding:10px;}
    input{font-size:12px;width:60%;}
    button{font-size:12px;padding:4px 6px;}
  }

  /* 보상 영상 오버레이 */
  .video-overlay{
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);
    z-index:2000; align-items:center; justify-content:center;
  }
  .video-box{
    width:min(70vw,420px); background:#000; border-radius:12px; overflow:hidden; box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  video{width:100%; height:auto; display:block}
</style>
</head>
<body>
  <div class="grid-container" id="grid"></div>

  <div class="container">
    <div class="input-container">
      <input type="text" id="answer" autocomplete="off">
      <button id="submitBtn">입력</button>
    </div>
  </div>

  <div class="button-container">
    <button id="hint1">힌트 1</button>
    <button id="hint2" disabled>힌트 2</button>
    <button id="answerBtn" disabled>정답 보기</button>
    <button id="totalBtn">츄르 합계</button>
  </div>

  <!-- 일반 안내 모달 -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <p id="modalText"></p>
    </div>
  </div>

  <!-- 1단계 정답 모달 -->
  <div id="correctModal" class="modal">
    <span class="close" id="closeCorrect">&times;</span>
    <img id="modalImage" src="racoonman.png" alt="정답 이미지">
    <p id="modalTextBelow">
      너구리였잖아!<br>매튜의 집을 어지럽힌 너구리를 찾아야 해.
      <br>창을 닫으면 새로운 미션이 주어질 거야.</p>
  </div>

  <!-- 미션(인트로) 영상 오버레이 -->
  <div id="missionOverlay" aria-hidden="true">
    <div class="video-box">
      <video id="missionVideo" playsinline muted></video>
    </div>
  </div>

  <!-- 보상 영상 -->
  <div id="videoOverlay" class="video-overlay" aria-hidden="true">
    <div class="video-box">
      <video id="rewardVideo" playsinline muted></video>
    </div>
  </div>

<script>
/* ============= 이미지 그리드 ============= */
const grid = document.getElementById('grid');
const allImages = [
  ['racoon0.png','racoon5.png','racoon1.png','puzzle1.png','racoon23.png'],
  ['racoon0.png','racoon17.png','racoon2.png','puzzle2.png','racoon30.png'],
  ['racoon0.png','racoon24.png','racoon16.png','racoon3.png','puzzle3.png'],
  ['racoon0.png','racoon15.png','racoon30.png','racoon3.png','puzzle4.png'],
  ['racoon0.png','racoon8.png','racoon29.png','racoon3.png','puzzle3.png'],
  ['racoon0.png','racoon11.png','racoon4.png','puzzle1.png','racoon25.png'],
  ['racoon0.png','racoon16.png','racoon5.png','puzzle2.png','racoon28.png'],
  ['racoon0.png','racoon6.png','puzzle5.png','racoon8.png','racoon12.png'],
  ['racoon0.png','racoon13.png','racoon7.png','puzzle6.png','racoon10.png'],
  ['racoon0.png','racoon18.png','racoon19.png','racoon8.png','puzzle7.png'],
  ['racoon0.png','racoon19.png','racoon18.png','racoon9.png','puzzle6.png'],
  ['racoon0.png','racoon17.png','racoon16.png','racoon10.png','puzzle8.png'],
  ['racoon0.png','racoon25.png','racoon11.png','puzzle5.png','racoon22.png'],
  ['racoon0.png','racoon12.png','puzzle5.png','racoon24.png','racoon5.png'],
  ['racoon0.png','racoon23.png','racoon9.png','racoon13.png','puzzle9.png'],
  ['racoon0.png','racoon25.png','racoon24.png','racoon14.png','puzzle10.png'],
  ['racoon0.png','racoon18.png','racoon15.png','puzzle11.png','racoon19.png'],
  ['racoon0.png','racoon10.png','racoon16.png','puzzle12.png','racoon18.png'],
  ['racoon0.png','racoon25.png','racoon15.png','puzzle13.png','racoon24.png'],
  ['racoon0.png','racoon30.png','racoon26.png','racoon17.png','puzzle14.png'],
  ['racoon0.png','racoon13.png','racoon9.png','racoon18.png','puzzle15.png'],
  ['racoon0.png','racoon19.png','puzzle6.png','racoon12.png','racoon20.png'],
  ['racoon0.png','racoon17.png','racoon20.png','puzzle5.png','racoon24.png'],
  ['racoon0.png','racoon18.png','racoon2.png','racoon21.png','puzzle7.png'],
  ['racoon0.png','racoon19.png','racoon16.png','racoon22.png','puzzle7.png'],
  ['racoon0.png','racoon20.png','racoon27.png','racoon23.png','puzzle8.png'],
  ['racoon0.png','racoon30.png','racoon24.png','puzzle5.png','racoon2.png'],
  ['racoon0.png','racoon25.png','puzzle5.png','racoon30.png','racoon6.png'],
  ['racoon0.png','racoon26.png','puzzle16.png','racoon16.png','racoon2.png'],
  ['racoon0.png','racoon27.png','puzzle17.png','racoon18.png','racoon24.png'],
  ['racoon0.png','racoon1.png','racoon28.png','puzzle18.png','racoon26.png'],
  ['racoon0.png','racoon24.png','racoon29.png','puzzle19.png','racoon22.png'],
  ['racoon0.png','racoon17.png','racoon30.png','puzzle18.png','racoon25.png'],
  ['racoon0.png','racoon31.png','puzzle16.png','racoon20.png','racoon23.png'],
  ['racoon0.png','racoon32.png','puzzle17.png','racoon12.png','racoon24.png'],
  ...Array.from({length:33},(_,i)=>[
    `image${i+4}_1.jpg`,`image${i+4}_2.jpg`,`image${i+4}_3.jpg`,`image${i+4}_4.jpg`,`image${i+4}_5.jpg`
  ])
];

for (let i=0;i<35;i++){
  const box=document.createElement('div');
  box.classList.add('image-box');
  let idx=0;
  box.style.backgroundImage=`url(${allImages[i][idx]})`;
  box.addEventListener('click',()=>{
    idx=(idx+1)%allImages[i].length;
    box.style.backgroundImage=`url(${allImages[i][idx]})`;
  });
  grid.appendChild(box);
}

/* ============= 상태 / 스토리지 ============= */
const nextUrl = "https://baekko.github.io/baekkohouse/ctm41.html";

let currentAnswer = "너구리"; // Q1 → Q2("5638")
let currentQuestion = 1;

let answeredQuestions = 0;
let hintLevel1 = 0; // Q1 힌트 단계
let hintLevel2 = 0; // Q2 힌트 단계

const CHURU_KEY = "churuTotal";
const PAGE_KEY_Q1 = "settled:" + location.pathname + ":q1";
const PAGE_KEY_Q2 = "settled:" + location.pathname + ":q2";

if (localStorage.getItem(CHURU_KEY) === null) localStorage.setItem(CHURU_KEY,"0");

/* ============= 힌트/정답 텍스트 ============= */
const hints = {
  "너구리": { hint1:"0을 터치 하면 그림이 바뀔거야!", hint2:"각 칸의 숫자만큼 터치해!", answer:"너구리" },
  "5638":   { hint1:"너구리를 건드려!",            hint2:"너구리를 한 번씩만 더 눌러 보라니까!", answer:"5638" }
};
const wrongMessages = { "너구리":"침입자가 아냐.", "5638":"한 번씩만 더 누르면 된다고!" };

/* ============= 요소 ============= */
const $answer = document.getElementById('answer');
const $submit = document.getElementById('submitBtn');

const $modal = document.getElementById('modal');
const $modalText = document.getElementById('modalText');
const $close = document.getElementById('closeModal');

const $correctModal = document.getElementById('correctModal');
const $closeCorrect = document.getElementById('closeCorrect');

const $hint1 = document.getElementById('hint1');
const $hint2 = document.getElementById('hint2');
const $ansBtn = document.getElementById('answerBtn');
const $totalBtn = document.getElementById('totalBtn');

const $overlay = document.getElementById('videoOverlay');
const $video = document.getElementById('rewardVideo');

/* ============= 항상 처음은 기본 배경으로 강제 리셋 ============= */
/* 1) 혹시 남아있을 수 있는 옛 플래그 제거 + CSS/인라인 강제 적용 */
(function enforceDefaultBG(){
  try{
    localStorage.removeItem('bgChanged:ctm38');
    sessionStorage.removeItem('bgChanged:ctm38');
  }catch(e){}
  document.body.style.backgroundImage = 'url("ctmt38.jpg")';
})();

/* 2) bfcache로 복원되어도 첫 프레임은 기본 배경 */
window.addEventListener('pageshow', function(){
  document.body.style.backgroundImage = 'url("ctmt38.jpg")';
});

/* ============= 모달 공통 ============= */
function openModal(txt){ $modalText.innerText = txt; $modal.style.display="block"; }
function closeModal(){ $modal.style.display="none"; }
$close.onclick = closeModal;
window.addEventListener('click', e => { if (e.target === $modal) closeModal(); });

/* ============= 힌트/정답 보기 ============= */
$hint1.onclick = ()=>{ openModal(hints[currentAnswer].hint1); if(currentQuestion===1){ if(hintLevel1<1)hintLevel1=1;}else{ if(hintLevel2<1)hintLevel2=1;} $hint2.disabled=false; };
$hint2.onclick = ()=>{ openModal(hints[currentAnswer].hint2); if(currentQuestion===1){ if(hintLevel1<2)hintLevel1=2;}else{ if(hintLevel2<2)hintLevel2=2;} $ansBtn.disabled=false; };
$ansBtn.onclick = ()=>{ openModal(hints[currentAnswer].answer); if(currentQuestion===1){ if(hintLevel1<3)hintLevel1=3;}else{ if(hintLevel2<3)hintLevel2=3;} };
$totalBtn.onclick = ()=>{ const t=Number(localStorage.getItem(CHURU_KEY)||"0"); openModal(`현재까지 획득한 츄르: ${t}개`); };

/* ============= 정답 제출 ============= */
$submit.onclick = checkAnswer;
$answer.addEventListener('keydown', e=>{ if(e.key === 'Enter') checkAnswer(); });

function checkAnswer(){
  const v = ($answer.value||"").trim();
  if (v === currentAnswer){
    answeredQuestions++;
    if (currentQuestion === 1){
      handleClearQ1();
    }else{
      handleClearQ2();
    }
  }else{
    openModal(wrongMessages[currentAnswer] || "오답입니다! 다시 시도해보세요.");
  }
}

/* ============= 문제 전환 ============= */
$closeCorrect.onclick = ()=>{ $correctModal.style.display = "none"; goNextQuestion("5638"); };
function goNextQuestion(nextAnswer){
  currentAnswer = nextAnswer; currentQuestion = 2;
  $answer.value = "";
  $hint1.disabled = false; $hint2.disabled = true; $ansBtn.disabled = true;
}

/* ============= 보상/가산 공통 ============= */
const addMap = [3,2,1,0];
function awardOnceAndPlay(questionIdx,hintLevelUsed,afterVideo){
  const key=(questionIdx===1)?PAGE_KEY_Q1:PAGE_KEY_Q2;
  if(localStorage.getItem(key)!=="1"){
    const add=addMap[hintLevelUsed]??0;
    const cur=Number(localStorage.getItem(CHURU_KEY)||"0");
    localStorage.setItem(CHURU_KEY,String(cur+add));
    localStorage.setItem(key,"1");
  }
  playRewardFor(hintLevelUsed,afterVideo);
}
function playRewardFor(hintLevelUsed,afterVideo){
  const src=["curu1.mp4","curu2.mp4","curu3.mp4","curu4.mp4"][hintLevelUsed]||"curu4.mp4";
  $video.src=src;
  $video.muted=true; $video.defaultMuted=true; $video.volume=0;
  [$hint1,$hint2,$ansBtn,$totalBtn,$submit].forEach(b=>b.disabled=true);
  $video.currentTime=0;
  $overlay.style.display="flex"; $overlay.setAttribute("aria-hidden","false");
  $video.onended=()=>{ $overlay.style.display="none"; if(typeof afterVideo==='function')afterVideo(); };
  const p=$video.play(); if(p&&typeof p.catch==="function"){ p.catch(()=>{ $video.setAttribute('controls','controls'); }); }
}

/* ============= 배경 변경(정답 시 ‘그 순간만’) ============= */
function applyChangedBackground(){
  document.body.style.backgroundImage = 'url("ctm381.jpg")';
}

/* ============= 각 문제 처리 ============= */
function handleClearQ1(){
  // 정답 순간에만 배경 교체 (어떤 저장도 하지 않음)
  applyChangedBackground();

  const used = hintLevel1;
  awardOnceAndPlay(1, used, ()=>{
    $correctModal.style.display="block";
    $hint1.disabled=false; $hint2.disabled=true; $ansBtn.disabled=true; $submit.disabled=false;
  });
}
function handleClearQ2(){
  const used=hintLevel2;
  awardOnceAndPlay(2,used,()=>{ location.href=nextUrl; });
}

/* ============= 미션 영상 오버레이 ============= */
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const $missionOverlay=document.getElementById('missionOverlay');
    const $missionVideo=document.getElementById('missionVideo');
    $missionVideo.src="mission.mp4";
    $missionVideo.muted=true;$missionVideo.defaultMuted=true;$missionVideo.volume=0;$missionVideo.currentTime=0;
    $missionOverlay.style.display="flex"; $missionVideo.style.display="block";
    $missionVideo.onended=()=>{ $missionOverlay.style.display="none"; $missionVideo.style.display="none"; $missionVideo.removeAttribute("src"); $missionVideo.load(); };
    const playPromise=$missionVideo.play(); if(playPromise&&typeof playPromise.catch==="function"){ playPromise.catch(()=>{ $missionVideo.setAttribute("controls","controls"); }); }
  },1000);
});
</script>
</body>
</html>










